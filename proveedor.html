<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proveedores y Contratos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="menu">
    <a href="dashboard.html">Dashboard</a>
    <a href="clientes.html">Clientes</a>
    <a href="proveedor.html">Proveedores</a>
    <a href="listado.html">Listado</a>
  </div>

  <div class="container">
    <h2>Crear nuevo proveedor</h2>
    <label>Nombre:</label>
    <input type="text" id="nombreProveedor">

    <label>Dirección:</label>
    <input type="text" id="direccionProveedor">

    <label>Tipo:</label>
    <select id="tipoProveedor">
      <option value="empresa">Empresa</option>
      <option value="persona">Persona física</option>
    </select>

    <label>Precio compra (€ con IVA):</label>
    <input type="number" id="precioCompra" step="0.01">

    <label>Variedad principal:</label>
    <select id="variedadProveedor">
      <option value="Clemenules">Clemenules</option>
      <option value="Navelina">Navelina</option>
      <option value="Navel">Navel</option>
      <option value="Lane Late">Lane Late</option>
      <option value="Salustiana">Salustiana</option>
      <option value="Valencia Late">Valencia Late</option>
      <option value="Sanguina">Sanguina</option>
      <option value="Oronules">Oronules</option>
      <option value="Hernandina">Hernandina</option>
      <option value="Marisol">Marisol</option>
      <option value="Orri">Orri</option>
      <option value="Tango">Tango</option>
      <option value="Nadorcott">Nadorcott</option>
      <option value="Otra">Otra</option>
    </select>

    <button onclick="guardarProveedor()">Guardar proveedor</button>

    <h2>Crear contrato para proveedor</h2>

    <label>Seleccionar proveedor:</label>
    <select id="selectorProveedor"></select>

    <label>Variedad:</label>
    <select id="variedadContrato">
      <option value="Clemenules">Clemenules</option>
      <option value="Navelina">Navelina</option>
      <option value="Navel">Navel</option>
      <option value="Lane Late">Lane Late</option>
      <option value="Salustiana">Salustiana</option>
      <option value="Valencia Late">Valencia Late</option>
      <option value="Sanguina">Sanguina</option>
      <option value="Oronules">Oronules</option>
      <option value="Hernandina">Hernandina</option>
      <option value="Marisol">Marisol</option>
      <option value="Orri">Orri</option>
      <option value="Tango">Tango</option>
      <option value="Nadorcott">Nadorcott</option>
      <option value="Otra">Otra</option>
    </select>

    <label>Kilos estimados:</label>
    <input type="number" id="kilosContrato">

    <label>IVA (%):</label>
    <select id="ivaContrato">
      <option value="4">4%</option>
      <option value="12">12%</option>
    </select>

    <label>Precio total con IVA (€):</label>
    <input type="number" id="precioConIVA" step="0.01">

    <label>Precio sin IVA (€):</label>
    <input type="number" id="precioSinIVA" step="0.01" readonly>

    <div class="info-contrato" id="infoContrato">Número de contrato: —</div>

    <button onclick="guardarContrato()">Guardar contrato</button>
  </div>

  <script>
    window.onload = () => {
      actualizarSelectorProveedor();
      document.getElementById("precioConIVA").addEventListener("input", actualizarPrecioSinIVA);
      document.getElementById("ivaContrato").addEventListener("change", actualizarPrecioSinIVA);
    };

    function guardarProveedor() {
      const proveedor = {
        id: Date.now(),
        nombre: document.getElementById("nombreProveedor").value,
        direccion: document.getElementById("direccionProveedor").value,
        tipo: document.getElementById("tipoProveedor").value,
        precio: parseFloat(document.getElementById("precioCompra").value),
        variedad: document.getElementById("variedadProveedor").value
      };

      if (!proveedor.nombre) {
        alert("El nombre del proveedor es obligatorio.");
        return;
      }

      let proveedores = JSON.parse(localStorage.getItem("proveedores") || "[]");
      proveedores.push(proveedor);
      localStorage.setItem("proveedores", JSON.stringify(proveedores));

      alert("Proveedor guardado.");
      actualizarSelectorProveedor();
    }

    function actualizarSelectorProveedor() {
      const selector = document.getElementById("selectorProveedor");
      selector.innerHTML = "";
      const proveedores = JSON.parse(localStorage.getItem("proveedores") || "[]");

      proveedores.forEach(p => {
        const option = document.createElement("option");
        option.value = p.id;
        option.textContent = p.nombre;
        selector.appendChild(option);
      });

      selector.onchange = () => actualizarNumeroContrato();
      if (selector.value) {
        selector.dispatchEvent(new Event("change"));
      }
    }

    function actualizarPrecioSinIVA() {
      const total = parseFloat(document.getElementById("precioConIVA").value) || 0;
      const iva = parseFloat(document.getElementById("ivaContrato").value) || 0;
      const base = total / (1 + iva / 100);
      document.getElementById("precioSinIVA").value = base.toFixed(2);
    }

    function actualizarNumeroContrato() {
      const contratos = JSON.parse(localStorage.getItem("contratos") || "[]");
      const hoy = new Date();
      const año = hoy.getFullYear();
      const contratosEsteAño = contratos.filter(c => new Date(c.fecha).getFullYear() === año);
      const numeroContrato = contratosEsteAño.length + 1;
      document.getElementById("infoContrato").textContent = `Número de contrato: ${numeroContrato} (Año ${año})`;
    }

    function guardarContrato() {
      const proveedorId = document.getElementById("selectorProveedor").value;
      const variedad = document.getElementById("variedadContrato").value;
      const kilos = parseFloat(document.getElementById("kilosContrato").value);
      const total = parseFloat(document.getElementById("precioConIVA").value);
      const iva = parseFloat(document.getElementById("ivaContrato").value);
      const precio = parseFloat(document.getElementById("precioSinIVA").value);

      if (!proveedorId || !variedad || isNaN(kilos) || isNaN(total)) {
        alert("Rellena todos los datos del contrato.");
        return;
      }

      const contratos = JSON.parse(localStorage.getItem("contratos") || "[]");
      const hoy = new Date();
      const año = hoy.getFullYear();
      const contratosEsteAño = contratos.filter(c => new Date(c.fecha).getFullYear() === año);
      const numeroContrato = contratosEsteAño.length + 1;

      const contrato = {
        id: Date.now(),
        proveedorId,
        variedad,
        kilos,
        precio,
        iva,
        total,
        año: año,
        numeroContrato: numeroContrato,
        fecha: hoy.toISOString()
      };

      contratos.push(contrato);
      localStorage.setItem("contratos", JSON.stringify(contratos));

      alert(`Contrato #${numeroContrato} del año ${año} guardado correctamente.`);
      actualizarNumeroContrato();
    }
  </script>
</body>
</html>
